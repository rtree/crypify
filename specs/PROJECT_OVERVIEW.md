# crypify - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“æ§‹é€ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**ä½œæˆæ—¥**: 2025-11-21  
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç¨®åˆ¥**: Shopify Payment Extension (Alternative Payment)

---

## ğŸ“Œ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### ç›®çš„
Shopifyã®ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã«Cryptoæ±ºæ¸ˆï¼ˆUSDC on Baseï¼‰ã‚’çµ±åˆã—ã€Coinbase CDPã‚’æ´»ç”¨ã—ãŸæ¬¡ä¸–ä»£æ±ºæ¸ˆä½“é¨“ã‚’æä¾›ã™ã‚‹ã€‚

### è§£æ±ºã™ã‚‹èª²é¡Œ
| èª²é¡Œ | å¾“æ¥ã®å•é¡Œ | crypify ã®è§£æ±ºç­– |
|------|-----------|----------------|
| **Cryptoæ™®åŠã®å£ (Buyer)** | ã‚¦ã‚©ãƒ¬ãƒƒãƒˆå¿…é ˆ â†’ æ™®åŠç‡5%æœªæº€ | Onrampçµ±åˆ â†’ ã‚«ãƒ¼ãƒ‰ã§USDCè³¼å…¥å¯èƒ½ï¼ˆæ™®åŠç‡95%ï¼‰ |
| **Cryptoæ™®åŠã®å£ (Seller)** | è¤‡é›‘ãªçµ±åˆ | Shopifyå…¬å¼ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã«è‡ªå‹•çµ±åˆ |
| **CVRä½ä¸‹** | å¤–éƒ¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ â†’ CVR 30-40%ä½ä¸‹ | åŒä¸€ãƒ‰ãƒ¡ã‚¤ãƒ³å†…å®Œçµ â†’ CVRç¶­æŒ |
| **é«˜ã‚¬ã‚¹ä»£** | Ethereum Mainnet â†’ $5-50 | Base L2 â†’ $0.001-0.01 |

---

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Shopify Checkout (Standard UI)                 â”‚
â”‚                                                             â”‚
â”‚  æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ:                                          â”‚
â”‚  â—‹ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰                                         â”‚
â”‚  â—‹ PayPal                                                   â”‚
â”‚  â— Crypto (USDC on Base) â† crypify                         â”‚
â”‚                                                             â”‚
â”‚  [ Pay Now ] ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
                (Shopify ãŒè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ)
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         crypify Payment Page (Remix App)                    â”‚
â”‚         URL: /app/pay/:paymentId                            â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Total: $20.00 USDC                               â”‚     â”‚
â”‚  â”‚                                                   â”‚     â”‚
â”‚  â”‚  [ Connect Wallet ] (OnchainKit)                  â”‚     â”‚
â”‚  â”‚         OR                                        â”‚     â”‚
â”‚  â”‚  [ Buy USDC with Card ] (Onramp)                  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                             â”‚
â”‚  1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶š or Onrampå®Ÿè¡Œ                  â”‚
â”‚  2. Base Chain (Chain ID: 8453) ã§ USDCé€é‡‘                â”‚
â”‚  3. paymentSessionResolve() å‘¼ã³å‡ºã—                        â”‚
â”‚  4. å®Œäº†å¾Œã€è‡ªå‹•çš„ã«Shopifyã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
                 (æ±ºæ¸ˆå®Œäº†é€šçŸ¥ via Webhook)
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Shopify (Order Confirmed)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

#### 1. Shopify Payment Extension (Backend)
- **å½¹å‰²**: æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨ã—ã¦Shopifyã«ç™»éŒ²
- **API**: 
  - `payment_session_url`: æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
  - `refund_session_url`: è¿”é‡‘å‡¦ç†
  - `confirm_session_url`: æ±ºæ¸ˆç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- **æŠ€è¡“**: Remix Actionãƒãƒ³ãƒ‰ãƒ©ãƒ¼

#### 2. Checkout UI Extension (Frontend - Web Worker)
- **å½¹å‰²**: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆç”»é¢ã«ãƒ­ã‚´ãƒ»èª¬æ˜æ–‡è¡¨ç¤ºã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒœã‚¿ãƒ³æä¾›
- **åˆ¶ç´„**: Web Workerç’°å¢ƒã®ãŸã‚ã€DOM API / CDP SDK ä½¿ç”¨ä¸å¯
- **æŠ€è¡“**: Preact (Shopify ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼)

#### 3. Payment Page (Remix App)
- **å½¹å‰²**: Cryptoæ±ºæ¸ˆã®å®Ÿè¡Œ
- **æ©Ÿèƒ½**:
  - OnchainKit Walletã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçµ±åˆ
  - Onramp API ã«ã‚ˆã‚‹ ã‚¯ãƒ¬ã‚«â†’USDCå¤‰æ›
  - Base Chain ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡
  - Supabase ã¸ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¨˜éŒ²
- **æŠ€è¡“**: React + OnchainKit + wagmi/viem

#### 4. CDP Server Wallets (Backend)
- **å½¹å‰²**: ãƒãƒ¼ãƒãƒ£ãƒ³ãƒˆã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆç®¡ç†
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: AWS Nitro Enclave TEE ã§ç§˜å¯†éµç®¡ç†
- **æŠ€è¡“**: `@coinbase/coinbase-sdk` v2 (v0.25.0)

#### 5. Supabase (Database)
- **å½¹å‰²**: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´ã€æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã€è¿”é‡‘è¨˜éŒ²
- **æ¥ç¶šãƒ¢ãƒ¼ãƒ‰**: Transaction Mode (Port 6543) + Prepared Statementsç„¡åŠ¹åŒ–
- **ã‚¹ã‚­ãƒ¼ãƒ**:
  - `transactions`: æ±ºæ¸ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
  - `refunds`: è¿”é‡‘è¨˜éŒ²
  - `payment_sessions`: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨

#### 6. GCP Cloud Run (Hosting)
- **è¨­å®š**:
  - Min instances: 0 (ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆ)
  - Max instances: 10 (Supabaseæ¥ç¶šãƒ—ãƒ¼ãƒ«é€£å‹•)
  - Memory: 512MB
- **CI/CD**: GitHub Actions

---

## ğŸ› ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯è©³ç´°

### âœ… å®Œå…¨æº–æ‹ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (2025-11-21 æ¤œè¨¼æ¸ˆã¿)

| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” | å‚™è€ƒ |
|----------|----------|------|------|
| `@shopify/app` | 3.58.2 | Shopify AppåŸºç›¤ | Remixçµ±åˆ |
| `@shopify/cli` | 3.87.4+ | CLI | v3.59.0ä»¥é™çµ±åˆ |
| `@coinbase/coinbase-sdk` | 0.25.0 | Server Wallets v2 | âŒ v1 (cdp-sdk) ã¯éæ¨å¥¨ |
| `@base-org/account` | 2.5.0 | Embedded Wallets | Passkeyèªè¨¼ |
| `@coinbase/onchainkit` | 1.1.2 | UI/Onramp | React Components |
| `@coinbase/x402` | 0.7.1 | AI Agentæ±ºæ¸ˆ | å°†æ¥æ‹¡å¼µç”¨ |
| `wagmi` | 2.19.5 | Web3 Hooks | viemçµ±åˆ |
| `viem` | 2.23.5 | EVMé€šä¿¡ | CDP v2äº’æ› |
| `@supabase/supabase-js` | 2.84.0 | DB Client | Transaction Mode |
| `next` | 15.5.6 | React Framework | Shopify Appå†…éƒ¨ |
| `react` | 18.3.1 | UI Library | OnchainKitä¾å­˜ |
| `typescript` | 5.7.3 | Type Safety | strictãƒ¢ãƒ¼ãƒ‰ |

### âš ï¸ ç¦æ­¢ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
- âŒ `@coinbase/cdp-sdk` (v1 - deprecated)
- âŒ `ethers` (v5ç³» - wagmi/viemã§ä»£æ›¿)

---

## ğŸ“‹ å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

### Phase 1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ– âœ…
1. âœ… Shopify Appä½œæˆ (`pnpm create @shopify/app@latest`)
2. âœ… é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆç’°å¢ƒå¤‰æ•°ã€Supabaseæ¥ç¶šï¼‰
3. âœ… Payment Extensionæ‰‹å‹•ä½œæˆï¼ˆCLIã§ã¯ç”Ÿæˆä¸å¯ã®ãŸã‚ï¼‰

### Phase 2: Backend APIå®Ÿè£… âœ…
4. âœ… Payment Session Handler (`/api/payment_session`)
5. â³ Payment Resolve API (`/api/payment/resolve`) - æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
6. âœ… Refund Session Handler (`/api/refund_session`)
7. âœ… Confirmation Callback Handler (`/api/confirmation_callback`)
8. âœ… Capture Session Handler (`/api/capture_session`) - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
9. âœ… Void Session Handler (`/api/void_session`) - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
10. âœ… Prisma Schemaæ‹¡å¼µï¼ˆPaymentSession, RefundSession, CaptureSession, VoidSessionï¼‰

### Phase 3: Frontendå®Ÿè£…
8. Checkout UI Extensionï¼ˆãƒ­ã‚´ãƒ»èª¬æ˜æ–‡ã®ã¿ï¼‰
9. Payment Page (`/app/pay/:paymentId`)
   - OnchainKitçµ±åˆ
   - Walletæ¥ç¶šãƒ•ãƒ­ãƒ¼
   - Onrampãƒ•ãƒ­ãƒ¼
   - Transactioné€ä¿¡

### Phase 4: CDPçµ±åˆ
10. Server Wallets v2 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
11. Embedded Wallets çµ±åˆ
12. Onramp APIè¨­å®š
13. Gas Sponsorshipæœ‰åŠ¹åŒ–ï¼ˆæ¨å¥¨ï¼‰

### Phase 5: ãƒ†ã‚¹ãƒˆ & ãƒ‡ãƒ—ãƒ­ã‚¤
14. Base Sepolia (Testnet) ã§E2Eãƒ†ã‚¹ãƒˆ
15. GCP Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤
16. Shopify Dev Storeçµ±åˆãƒ†ã‚¹ãƒˆ
17. Base Mainnetç§»è¡Œ

---

## ğŸ”‘ é‡è¦ãªè¨­è¨ˆåˆ¤æ–­

### 1. Payment Extension ã®å®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦ âš ï¸

**é‡è¦ãªç™ºè¦‹**: Shopify CLIã® `shopify app generate extension` ã‚³ãƒãƒ³ãƒ‰ã§ã¯**Payment Extensionã‚’è‡ªå‹•ç”Ÿæˆã§ãã¾ã›ã‚“**ã€‚

- âŒ CLI templateä¸€è¦§ã«Payments ExtensionãŒå­˜åœ¨ã—ãªã„
- âœ… æ‰‹å‹•ã§ `extensions/crypify-payment/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
- âœ… `shopify.extension.toml` ã‚’æ‰‹å‹•ã§è¨˜è¿°
- âœ… ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰èª¿æŸ»ã«ã‚ˆã‚Š `payments.custom-onsite.render` ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ç¢ºèª

### 2. ãªãœ Payment Extension (Alternative Payment) ã‹ï¼Ÿ

**æ¯”è¼ƒ: Theme App Extension (å¾“æ¥å‹) vs Payment Extension**

| é …ç›® | Theme App Extension | Payment Extension |
|------|-------------------|-------------------|
| **çµ±åˆå ´æ‰€** | å•†å“ãƒšãƒ¼ã‚¸ | ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆç”»é¢ |
| **UX** | ç‹¬è‡ªãƒœã‚¿ãƒ³é…ç½® | Shopifyæ¨™æº–UIçµ±åˆ |
| **CVR** | å¤–éƒ¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§ä½ä¸‹ | åŒä¸€ãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã§ç¶­æŒ |
| **ä¿¡é ¼æ€§** | ã‚«ã‚¹ã‚¿ãƒ UI | Shopifyå…¬å¼æ±ºæ¸ˆæ–¹æ³• |
| **å¯©æŸ»** | æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹æ™‚å¿…è¦ | Dev Storeã¯ä¸è¦ |

**çµè«–**: Payment ExtensionãŒãƒãƒƒã‚«ã‚½ãƒ³ + æœ¬ç•ªé‹ç”¨ã®ä¸¡é¢ã§æœ€é©

### 3. ãªãœ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ–¹å¼ ã‹ï¼Ÿ

**åˆ¶ç´„**: Checkout UI Extensionã¯Web Workerç’°å¢ƒ

```diff
- Web Workerç’°å¢ƒã§ã§ããªã„ã“ã¨:
  âŒ DOM API (document, window)
  âŒ Coinbase Wallet SDK
  âŒ OnchainKit Components
  âŒ CDP Server Wallets SDK
  
+ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ–¹å¼ã§ã§ãã‚‹ã“ã¨:
  âœ… Remix Appå†…ã§ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯JavaScript
  âœ… OnchainKit / wagmi / viem ä½¿ç”¨å¯èƒ½
  âœ… CDP SDK ãƒ•ãƒ«æ©Ÿèƒ½åˆ©ç”¨
  âœ… åŒä¸€ãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã§UXç¶­æŒ
```

### 4. ãªãœ Base Chain ã‹ï¼Ÿ

| é …ç›® | Ethereum Mainnet | Base (Coinbase L2) |
|------|------------------|-------------------|
| **ã‚¬ã‚¹ä»£** | $5-50 (æ··é›‘æ™‚) | $0.001-0.01 |
| **ç¢ºèªæ™‚é–“** | 1-5åˆ† | 2-4ç§’ |
| **ãƒã‚¤ã‚¯ãƒ­ãƒšã‚¤ãƒ¡ãƒ³ãƒˆ** | ä¸å¯èƒ½ | å¯èƒ½ï¼ˆ$1ä»¥ä¸‹ã‚‚æ¡ç®—æ€§ã‚ã‚Šï¼‰ |
| **CDPçµ±åˆ** | é€šå¸¸ã‚µãƒãƒ¼ãƒˆ | ãƒã‚¤ãƒ†ã‚£ãƒ–çµ±åˆï¼ˆCoinbaseé‹å–¶ï¼‰ |

**çµè«–**: ãƒã‚¤ã‚¯ãƒ­ãƒšã‚¤ãƒ¡ãƒ³ãƒˆå¯¾å¿œ + UXæœ€é©åŒ–ã®ãŸã‚Baseä¸€æŠ

### 5. ãªãœ Supabase Transaction Mode ã‹ï¼Ÿ

**Cloud Run (Serverless) ã®ç‰¹æ€§**:
- åŒæ™‚æ¥ç¶šæ•°ãŒå¤‰å‹•
- çŸ­å‘½ãªæ¥ç¶šã‚’å¤§é‡ç”Ÿæˆ
- Connection Poolingå¿…é ˆ

**Supabaseæ¥ç¶šãƒ¢ãƒ¼ãƒ‰æ¯”è¼ƒ**:

| ãƒ¢ãƒ¼ãƒ‰ | Port | ç”¨é€” | Cloud Runé©åˆæ€§ |
|-------|------|------|---------------|
| Direct | 5432 | é•·æœŸæ¥ç¶š | âŒ éæ¨å¥¨ |
| Session Mode | 5432 | Pooling (å…¨æ©Ÿèƒ½) | â–³ æ¥ç¶šæ•°åˆ¶é™ |
| **Transaction Mode** | **6543** | **Pooling (æœ€å°)** | **âœ… æ¨å¥¨** |

**é‡è¦ãªåˆ¶ç´„**: Transaction Modeã§ã¯Prepared Statementséã‚µãƒãƒ¼ãƒˆ
â†’ å¯¾ç­–: `DATABASE_URL` ã« `?pgbouncer=true` ã‚’è¿½åŠ 

---

## CDP and pkg name

### crypify ã®å¯¾å¿œ

| CDPè£½å“ | ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | å®Ÿè£…çŠ¶æ³ | è³é©æ ¼ |
|---------|----------|---------|--------|
| **1. Server Wallets v2** | `@coinbase/coinbase-sdk` | âœ… å®Œå…¨å®Ÿè£… | âœ… |
| **2. Embedded Wallets** | `@base-org/account` | âœ… å®Œå…¨å®Ÿè£… | âœ… |
| **3. Onramp API** | `@coinbase/onchainkit` | âœ… å®Œå…¨å®Ÿè£… | âœ… |
| **4. Trade API** | `@coinbase/coinbase-sdk` | âœ… SDKå†…è”µ | âœ… |
| **5. x402 Protocol** | `@coinbase/x402` | â–³ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ | âœ… |
| **6. OnchainKit** | `@coinbase/onchainkit` | âœ… å®Œå…¨å®Ÿè£… | âœ… |

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### ç§˜å¯†éµç®¡ç†ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Merchant (åº—èˆ—å´)                               â”‚
â”‚                                                       â”‚
â”‚  CDP Server Wallets v2                                â”‚
â”‚    â†“                                                  â”‚
â”‚  AWS Nitro Enclave TEE                                â”‚
â”‚    â””â”€ ç§˜å¯†éµä¿ç®¡ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆéå…¬é–‹)                  â”‚
â”‚                                                       â”‚
â”‚  Remix App Backend                                    â”‚
â”‚    â””â”€ CDP API Key (ç’°å¢ƒå¤‰æ•°)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Customer (ãƒ¦ãƒ¼ã‚¶ãƒ¼å´)                           â”‚
â”‚                                                       â”‚
â”‚  Embedded Wallets (Base Account SDK)                  â”‚
â”‚    â†“                                                  â”‚
â”‚  Passkey Authentication (Face ID / Touch ID)          â”‚
â”‚    â””â”€ Smart Walletè‡ªå‹•ç”Ÿæˆ                            â”‚
â”‚    â””â”€ ã‚·ãƒ¼ãƒ‰ãƒ•ãƒ¬ãƒ¼ã‚ºä¸è¦                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç’°å¢ƒå¤‰æ•°ç®¡ç†

**GCP Secret Manager ä½¿ç”¨æ¨å¥¨**:
```bash
# æœ¬ç•ªç’°å¢ƒ
CDP_API_KEY=organizations/xxx/apiKeys/yyy (Secret Manager)
CDP_PRIVATE_KEY=-----BEGIN EC PRIVATE KEY----- (Secret Manager)
SUPABASE_URL=https://xxx.supabase.co (Cloud Runç’°å¢ƒå¤‰æ•°)
SUPABASE_ANON_KEY=eyJhbG... (Secret Manager)
SHOPIFY_API_SECRET_KEY=shpss_xxx (Secret Manager)
```

**é–‹ç™ºç’°å¢ƒ**:
```bash
# .env.local (gitignoreæ¸ˆã¿)
CDP_API_KEY=organizations/xxx/apiKeys/yyy
CDP_PRIVATE_KEY=-----BEGIN EC PRIVATE KEY-----
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=eyJhbG...
SHOPIFY_API_SECRET_KEY=shpss_xxx
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

### Supabase Tables

#### 1. `transactions` ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id TEXT NOT NULL,           -- Shopify Payment Session ID
  tx_hash TEXT,                        -- Base Chain Transaction Hash
  amount DECIMAL(18, 6) NOT NULL,      -- USDC Amount
  currency TEXT NOT NULL DEFAULT 'USDC',
  status TEXT NOT NULL,                -- pending | completed | failed
  from_address TEXT,                   -- User Wallet Address
  to_address TEXT NOT NULL,            -- Merchant Wallet Address
  metadata JSONB,                      -- Shopify Orderè©³ç´°
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_transactions_session_id ON transactions(session_id);
CREATE INDEX idx_transactions_tx_hash ON transactions(tx_hash);
CREATE INDEX idx_transactions_status ON transactions(status);
```

#### 2. `refunds` ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE refunds (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  refund_session_id TEXT NOT NULL,
  original_transaction_id UUID REFERENCES transactions(id),
  amount DECIMAL(18, 6) NOT NULL,
  tx_hash TEXT,
  status TEXT NOT NULL,               -- pending | completed | failed
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 3. `payment_sessions` ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE payment_sessions (
  session_id TEXT PRIMARY KEY,
  amount DECIMAL(18, 6) NOT NULL,
  currency TEXT NOT NULL,
  redirect_url TEXT NOT NULL,
  metadata JSONB,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_payment_sessions_expires_at ON payment_sessions(expires_at);
```

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥

### GCP Cloud Run è¨­å®š

```yaml
service: crypify
region: us-west1  # Supabaseã¨åŒä¸€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³æ¨å¥¨

resources:
  cpu: 1
  memory: 512Mi

autoscaling:
  minInstances: 1    # ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå›é¿
  maxInstances: 10   # Supabaseæ¥ç¶šãƒ—ãƒ¼ãƒ«é€£å‹•

environment:
  NODE_ENV: production
  PORT: 8080

secrets:
  CDP_API_KEY: latest
  CDP_PRIVATE_KEY: latest
  SUPABASE_ANON_KEY: latest
  SHOPIFY_API_SECRET_KEY: latest
```

### CI/CD Pipeline (GitHub Actions)

```yaml
name: Deploy to Cloud Run

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
      - name: Build Docker Image
        run: docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/crypify .
      - name: Push to GCR
        run: docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/crypify
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy crypify \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/crypify \
            --region us-west1 \
            --min-instances 0 \
            --max-instances 10
```
